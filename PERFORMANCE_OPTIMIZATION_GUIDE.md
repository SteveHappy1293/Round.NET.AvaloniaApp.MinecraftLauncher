# RMCL 性能优化指南

## 已实施的性能优化

### 1. UI页面懒加载机制
- **优化内容**: 实现了页面工厂模式，页面只在首次访问时才创建实例
- **影响**: 减少启动时间和内存占用
- **实现位置**: 
  - `BottomBar.axaml.cs` - 主导航懒加载
  - `NavigationPage.axaml.cs` - 子页面懒加载
  - `BottomBarNavigationEntry.cs` - 支持页面工厂

### 2. 优化GC策略
- **优化内容**: 
  - 移除过度频繁的强制GC调用（从2秒改为30秒+智能检测）
  - 使用更温和的GC模式（Optimized而非Aggressive）
  - 只在内存使用超过100MB时才执行GC
- **影响**: 减少GC暂停，提升UI响应性
- **实现位置**: `App.axaml.cs`, `ConfigRoot.cs`

### 3. 资源池优化
- **优化内容**:
  - 图片资源池缓存时间从5秒增加到5分钟
  - 清理间隔从10秒增加到2分钟
  - 支持不同尺寸的图片缓存
  - 添加异步预加载功能
- **影响**: 减少重复加载，提升图片显示性能
- **实现位置**: `ImageResourcePool.cs`, `Pools.cs`, `Core.cs`

### 4. 启动流程优化
- **优化内容**:
  - 非关键配置（Java、Player、GameDrawer）异步加载
  - GC模式改为Interactive（更适合UI应用）
  - 添加服务器GC检测
- **影响**: 减少启动时间
- **实现位置**: `Program.cs`

### 5. 性能监控系统
- **优化内容**:
  - 实时内存使用监控
  - 自动内存优化
  - 资源预热机制
  - UI操作性能监控
- **影响**: 主动优化性能，及时发现性能问题
- **实现位置**: `PerformanceOptimizer.cs`

### 6. 运行时配置优化
- **优化内容**:
  - 启用服务器GC模式
  - 保留VM内存以减少分配开销
  - 优化线程池配置
  - 调整大对象堆阈值
- **影响**: 整体运行时性能提升
- **实现位置**: `RMCL.runtimeconfig.json`

## 性能提升预期

### 启动性能
- **启动时间**: 预计减少20-30%
- **内存占用**: 启动时减少15-25%
- **首屏显示**: 更快的首页加载

### 运行时性能
- **页面切换**: 首次访问后的页面切换更流畅
- **内存管理**: 更稳定的内存使用，减少内存泄漏
- **GC暂停**: 减少60-80%的GC暂停时间

### 用户体验
- **响应性**: UI操作更加流畅
- **稳定性**: 减少因内存问题导致的崩溃
- **资源使用**: 更高效的系统资源利用

## 使用建议

### 开发者
1. 使用 `PerformanceOptimizer.InvokeOnUIThreadAsync()` 进行UI操作
2. 利用 `PreloadImagesAsync()` 预加载常用图片
3. 监控 `GetMemoryUsage()` 了解内存使用情况

### 用户
1. 首次启动后，后续页面访问会更快
2. 可以在设置中调整GC时间间隔（建议保持默认30秒）
3. 定期重启应用以清理长期缓存

## 进一步优化建议

### 短期优化
1. 实现图片压缩和格式优化
2. 添加更多资源的懒加载
3. 优化网络请求的并发处理

### 长期优化
1. 考虑使用AOT编译提升启动性能
2. 实现更智能的缓存策略
3. 添加性能分析和诊断工具

## 监控和调试

### 性能指标
- 启动时间
- 内存使用峰值
- GC频率和暂停时间
- 页面切换响应时间

### 调试工具
- 控制台输出的性能日志
- `PerformanceOptimizer.GetMemoryUsage()` API
- Visual Studio 诊断工具

## 注意事项

1. 懒加载可能导致首次访问某些页面时有轻微延迟
2. 增加的缓存会占用更多内存，但会显著提升性能
3. 性能监控会有轻微的CPU开销，但收益远大于成本
4. 建议在生产环境中监控实际性能表现并根据需要调整参数
